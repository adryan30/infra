apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: istio
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  labels:
    name: istio
    app: istio
spec:
  project: default
  source:
    repoURL: https://istio-release.storage.googleapis.com/charts
    chart: istiod
    targetRevision: 1.28.0
    helm:
      valuesObject:
        pilot:
          cni:
            enabled: true
        platform: k3s
        meshConfig:
          extensionProviders:
            - name: oauth2-proxy
              envoyExtAuthzHttp:
                service: oauth2-proxy.keycloak.svc.cluster.local
                port: 4180
                headersToDownstreamOnDeny:
                  - content-type
                  - set-cookie
                headersToUpstreamOnAllow:
                  - authorization
                  - path
                  - x-auth-request-user
                  - x-auth-request-email
                  - x-auth-request-access-token
                includeHeadersInCheck:
                  - "authorization",
                  - "cookie",
                  - "x-forwarded-access-token",
                  - "x-forwarded-user",
                  - "x-forwarded-email",
                  - "x-forwarded-proto",
                  - "proxy-authorization",
                  - "user-agent",
                  - "x-forwarded-host",
                  - "from",
                  - "x-forwarded-for",
                  - "accept",
                  - "x-auth-request-redirect",
                includeHeadersInResponse:
                  - "authorization"
                  - "set-cookie"
                  - "x-auth-user"
          defaultConfig:
            terminationDrainDuration: 310s

  destination:
    server: https://kubernetes.default.svc
    namespace: istio-system

  ignoreDifferences:
    - group: admissionregistration.k8s.io
      kind: ValidatingWebhookConfiguration
      jqPathExpressions:
        - .webhooks[]?.failurePolicy

  syncPolicy:
    automated:
      enabled: true
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true

    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  revisionHistoryLimit: 3
