apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: oauth2-proxy
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "2"
  finalizers:
    - resources-finalizer.argocd.argoproj.io
  labels:
    name: oauth2-proxy
    app: oauth2-proxy
spec:
  project: default
  source:
    repoURL: https://oauth2-proxy.github.io/manifests
    chart: oauth2-proxy
    targetRevision: 8.3.3
    helm:
      valuesObject:
        config:
          existingSecret: oauth2-proxy-config
        service:
          portNumber: 4180
        extraArgs:
          provider: keycloak-oidc
          oidc-issuer-url: https://auth.adryan.me/realms/master
          cookie-secure: true
          cookie-samesite: lax
          cookie-refresh: 1h
          cookie-expire: 4h
          skip-provider-button: true
          upstream: static://200
          set-authorization-header: true
          pass-authorization-header: true
          pass-user-headers: true
          pass-host-header: true
          set-xauthrequest: true
          pass-access-token: true
          scope: "openid email"
          standard-logging: true
          auth-logging: true
          request-logging: true
          code-challenge-method: S256
          email-domain: "*"

        #   reverse-proxy: true
        #   whitelist-domain: <WHITELIST_DOMAIN>
        #   login-url: <LOGIN_URL>
        #   oidc-jwks-url: <JWKS_URL> # this is accessed by proxy in-mesh - http
        #   redeem-url: <REDEEM_URL> # This is accessed by proxy in-mesh - http
        #   skip-oidc-discovery: true
        #   oidc-issuer-url: <ISSUER_URL>

  destination:
    server: https://kubernetes.default.svc
    namespace: keycloak

  syncPolicy:
    automated:
      enabled: true
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true

    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  revisionHistoryLimit: 3
